name: Auto Release on Merge
 
on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
 
permissions:
  contents: write
 
jobs:
 
  validate_pr:
    # Run validation only when PR is NOT merged yet
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
 
    steps:
      - name: Check commit message for release flag
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
 
          if echo "$TITLE" | grep -iq "release: yes"; then
            echo "Commit message valid."
            exit 0
          fi
 
          if echo "$BODY" | grep -iq "release: yes"; then
            echo "Commit message valid."
            exit 0
          fi
 
          echo "âŒ ERROR: PR cannot be merged because it does not contain 'release: yes'"
          exit 1
 
 
  create_release:
    # Run only when PR is merged AND has release flag
    if: >
      github.event.pull_request.merged == true &&
      (
        contains(github.event.pull_request.title, 'release: yes') ||
        contains(github.event.pull_request.body, 'release: yes')
      )
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main
 
      - name: Extract version from composer.json
        id: version
        run: |
          VERSION=$(jq -r '.version' composer.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"
 
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ env.VERSION }}"
          release_name: "Release v${{ env.VERSION }}"
          body: |
            Auto-release generated for version v${{ env.VERSION }}
