name: Sync Version from Master Repo

on:
  repository_dispatch:
    types: [version_update]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_version:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------
      # Checkout repository
      # --------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      # --------------------------------------------
      # Sync Version
      # --------------------------------------------
      - name: Sync version from dispatch
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          set -e

          VERSION="${{ github.event.client_payload.version }}"
          echo "Incoming version: $VERSION"

          # Validate version (basic semver check)
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format. Expected X.Y.Z"
            exit 1
          fi

          CURRENT_VERSION=$(jq -r '.version' composer.json)
          echo "Current version: $CURRENT_VERSION"

          # Stop if versions match
          if [ "$VERSION" = "$CURRENT_VERSION" ]; then
            echo "✔ Versions already match. Nothing to sync."
            exit 0
          fi

          BRANCH="sync-version-v${VERSION}"
          echo "Using branch: $BRANCH"

          git config user.name "GitHub Actions Bot"
          git config user.email "ci-bot@github.com"

          # Check if branch already exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "Branch already exists. Skipping branch creation."
            git checkout "$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          # Update composer.json
          jq ".version = \"$VERSION\"" composer.json > tmp.json
          mv tmp.json composer.json

          git add composer.json

          # Commit only if changes exist
          if git diff --cached --quiet; then
            echo "No changes detected after update."
          else
            git commit -m "chore: sync version to v${VERSION}"
            git push https://x-access-token:${PAT}@github.com/${{ github.repository }} "$BRANCH"
          fi

          # Check if PR already exists
          if gh pr list \
              --head "$BRANCH" \
              --repo "${{ github.repository }}" \
              --token "${PAT}" \
              --json number \
              --jq 'length' | grep -q "1"; then
            echo "PR already exists for $BRANCH"
            exit 0
          fi

          # Create Pull Request
          gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "Sync version to v${VERSION}" \
            --body "Automated version sync from master repository." \
            --repo "${{ github.repository }}" \
            --token "${PAT}"
