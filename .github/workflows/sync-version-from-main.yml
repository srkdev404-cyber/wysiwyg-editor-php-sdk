name: Sync Version from Master Repo

on:
  repository_dispatch:
    types: [sync-version]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_version:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository (using PAT)
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      # -----------------------------
      # Sync Version
      # -----------------------------
      - name: Sync version from dispatch
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          set -e

          VERSION="${{ github.event.client_payload.version }}"
          echo "Incoming version: $VERSION"

          CURRENT_VERSION=$(jq -r '.version' composer.json)
          echo "Current version: $CURRENT_VERSION"

          # Stop if versions match
          if [ "$VERSION" = "$CURRENT_VERSION" ]; then
            echo "✔ Versions match → No action required."
            exit 0
          fi

          BRANCH="sync-version-v${VERSION}"
          echo "Creating branch: $BRANCH"

          git config user.name "GitHub Actions Bot"
          git config user.email "ci-bot@github.com"

          git checkout -b "$BRANCH"

          # Update composer.json
          jq ".version = \"$VERSION\"" composer.json > tmp.json
          mv tmp.json composer.json

          git add composer.json
          git commit -m "chore: sync version to v${VERSION}"

          git push https://x-access-token:${PAT}@github.com/${{ github.repository }} "$BRANCH"

          # Create PR
          gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "Sync version to v${VERSION}" \
            --body "Automated version sync from master repository." \
            --repo "${{ github.repository }}" \
            --token "${PAT}"
